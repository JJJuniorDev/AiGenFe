<div class="modal image-generator-modal" *ngIf="isOpen">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="close()">√ó</button>
    
    <div class="modal-header">
      <h2>üé® Generatore Immagini per {{ selectedBrand?.brandName }}</h2>
    </div>

    
    <!-- <div class="upload-section">
      <h3>üì§ Carica immagini del brand</h3>
      <div class="upload-area" 
           (dragover)="handleDragOver($event)"
           (drop)="handleDrop($event)">
        <input type="file" 
               accept="image/*" 
               (change)="onFileSelected($event)"
               id="imageUpload"
               multiple
               hidden>
        <label for="imageUpload" class="upload-label">
          <div class="upload-icon">üì§</div>
          <h4>Carica immagini del brand</h4>
          <p>Trascina immagini o clicca per selezionare</p>
          <p class="upload-hint">PNG, JPG, WebP (max 10MB ciascuna)</p>
          <p class="upload-hint">Puoi caricare fino a 5 immagini alla volta</p>
        </label>
      </div>

      <div *ngIf="isUploading" class="upload-progress">
        <div class="progress-bar" [style.width.%]="uploadProgress"></div>
        <span>{{ uploadProgress }}%</span>
      </div>

      
      <div *ngIf="referenceImages.length > 0" class="reference-section">
        <h4>Immagini del brand disponibili:</h4>
        <div class="reference-grid">
          <div *ngFor="let image of referenceImages" 
               class="reference-image"
               [class.selected]="isImageSelected(image)"
               (click)="toggleImageSelection(image)">
            <img [src]="image.imageUrl" [alt]="image.imageName || 'Immagine brand'">
            <div class="image-overlay">
              <span class="checkmark" *ngIf="isImageSelected(image)">‚úì</span>
            </div>
          </div>
        </div>
        <p class="selection-info">
          {{ selectedReferenceImages.length }} immagine{{ selectedReferenceImages.length !== 1 ? 'i' : '' }} selezionate
        </p>
      </div>
    </div> -->


    <!-- SEZIONE GENERAZIONE -->
    <div class="generate-section">
      <h3>üé® Genera nuova immagine</h3>
      
      <div class="prompt-section">
        <label>Descrizione dell'immagine che vuoi generare</label>
        <textarea 
          [(ngModel)]="generationPrompt" 
          placeholder="Esempio: Un prodotto in primo piano con sfondo neutro, perfetto per un post Instagram..."
          rows="4"
        ></textarea>
      </div>

      <div class="settings-section">
        <div class="setting">
          <label>Stile</label>
          <select [(ngModel)]="selectedStyle">
            <option *ngFor="let style of availableStyles" [value]="style.value">
              {{ style.label }}
            </option>
          </select>
        </div>

        <div class="setting">
          <label>Formato</label>
          <select [(ngModel)]="aspectRatio">
            <option value="1:1">Quadrato (1:1)</option>
            <option value="4:5">Verticale (4:5)</option>
            <option value="16:9">Orizzontale (16:9)</option>
            <option value="9:16">Stories (9:16)</option>
          </select>
        </div>
      </div>

      <button 
        class="generate-btn" 
        (click)="generateSingleImage()"
        [disabled]="isGenerating || !generationPrompt.trim()"
      >
        {{ isGenerating ? 'üé® Generazione in corso...' : 'üé® Genera Immagine' }}
      </button>
      
      <div *ngIf="selectedReferenceImages.length > 0" class="info-note">
        ‚ÑπÔ∏è Verranno usate {{ selectedReferenceImages.length }} immagine{{ selectedReferenceImages.length !== 1 ? 'i' : '' }} come riferimento
      </div>
    </div>

    <!-- SEZIONE VISUALIZZAZIONE E MODIFICA -->
    <div *ngIf="generatedImages.length > 0" class="generated-section">
      <h3>üñºÔ∏è Immagini Generate</h3>
      
      <!-- Galleria immagini -->
      <div class="image-gallery">
        <div 
          *ngFor="let image of generatedImages; let i = index" 
          class="image-thumbnail"
          [class.selected]="image === selectedImageForEditing"
          (click)="selectImageForEditing(image)"
        >
          <div class="thumbnail-container">
            <img 
              [src]="'data:image/png;base64,' + image.imageBase64" 
              [alt]="'Immagine ' + (i + 1)"
            >
            <div class="version-badge">V{{ getVersionNumber(image) }}</div>
            
            <div class="thumbnail-overlay">
              <span *ngIf="image.isEdit" class="edit-badge">‚úèÔ∏è #{{ image.editCount || 1 }}</span>
              <span *ngIf="image.savedToCloudinary" class="cloud-badge">‚òÅÔ∏è</span>
            </div>
          </div>
          
          <div class="thumbnail-info">
            <div class="thumbnail-number">#{{ i + 1 }}</div>
            <small class="version-text">Versione {{ getVersionNumber(image) }}</small>
          </div>
        </div>
      </div>

      <!-- Visualizzazione immagine selezionata -->
      <div *ngIf="selectedImageForEditing" class="selected-image-section">
        <div class="image-preview" >
          <div class="preview-container">
            <img 
              [src]="'data:image/png;base64,' + selectedImageForEditing.imageBase64" 
              [alt]="'Anteprima immagine ' + (selectedImageForEditing.editCount || 0)"
              (load)="onImageLoaded()"
            >
          </div>
        </div>
        
        <!-- Dettagli immagine -->
        <div class="image-details">
          <p><strong>Prompt usato:</strong> {{ selectedImageForEditing.promptUsed }}</p>
          <p><strong>Piattaforma:</strong> {{ selectedImageForEditing.platform }}</p>
          <p><strong>Dimensioni:</strong> {{ selectedImageForEditing.dimensions.width }}x{{ selectedImageForEditing.dimensions.height }}</p>
          <p *ngIf="selectedImageForEditing.isEdit">
            <strong>Modifiche:</strong> {{ (selectedImageForEditing.editCount || 0) + 1 }} volte
          </p>
        </div>

        <!-- Azioni immagine -->
        <div class="image-actions">
          <button 
            class="btn-action" 
            (click)="downloadImage(selectedImageForEditing)"
            title="Scarica"
          >
            ‚¨áÔ∏è Scarica
          </button>
          
          <button 
            class="btn-action" 
            *ngIf="!selectedImageForEditing.savedToCloudinary"
            (click)="saveImageToCloudinary(selectedImageForEditing)"
            [disabled]="isSaving"
            title="Salva su Cloudinary"
          >
            {{ isSaving ? 'Salvataggio...' : '‚òÅÔ∏è Salva' }}
          </button>
          
          <button 
            class="btn-action" 
            *ngIf="selectedImageForEditing.imageUrl"
            (click)="copyImageUrl(selectedImageForEditing.imageUrl!)"
            title="Copia URL"
          >
            üìã Copia URL
          </button>
        </div>

        <!-- Modifica immagine -->
        <div class="edit-section">
          <h4>‚úèÔ∏è Modifica questa immagine</h4>
          <textarea 
            [(ngModel)]="editPrompt" 
            placeholder="Descrivi come vuoi modificare l'immagine..."
            rows="3"
          ></textarea>
          <button 
            class="btn-edit" 
            (click)="editSelectedImage()"
            [disabled]="isEditing || !editPrompt.trim()"
          >
            {{ isEditing ? 'Modifica in corso...' : 'Applica Modifiche' }}
          </button>
          <p class="edit-hint" *ngIf="selectedImageForEditing.isEdit">
            Questa √® la versione #{{ (selectedImageForEditing.editCount || 0) + 1 }} dell'immagine
          </p>
        </div>
      </div>
    </div>

    <!-- Stato vuoto -->
    <div *ngIf="generatedImages.length === 0 && !isGenerating" class="empty-state">
      <div class="empty-icon">üé®</div>
      <p>Le immagini generate appariranno qui</p>
      <small>Scrivi un prompt e clicca "Genera Immagine"</small>
    </div>
  </div>
</div>