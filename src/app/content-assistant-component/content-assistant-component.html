<!-- components/content-assistant/content-assistant.component.html -->
<div class="content-assistant">
  <!-- Header -->
  <div class="assistant-header">
    <h3>ü§ñ Assistant Analisi Contenuto</h3>
    <p>Ottieni feedback immediato sul tuo contenuto</p>
  </div>

  <!-- Area Input -->
  <div class="input-section" [class.analyzing]="isAnalyzing">
    <div class="form-group">
      <label for="contentInput">Contenuto da analizzare</label>
      <textarea
        id="contentInput"
        [(ngModel)]="content"
        placeholder="Incolla qui il tuo contenuto (post, email, articolo...)"
        rows="8"
        [disabled]="isAnalyzing"
        (input)="resetAnalysis()">
      </textarea>
    </div>

    <div class="analysis-controls">
      <div class="form-group">
        <label for="analysisType">Tipo di analisi</label>
        <select 
          id="analysisType"
          [(ngModel)]="selectedAnalysisType"
          [disabled]="isAnalyzing">
          <option *ngFor="let type of analysisTypes; trackBy: trackByAnalysisType" 
                  [value]="type">
            {{ getAnalysisTypeLabel(type) }}
          </option>
        </select>
      </div>
    </div>

    <!-- Brand Info -->
    <div class="brand-info" [class.warning]="!selectedBrand">
      <div class="brand-info-content">
        <div class="brand-header">
          <strong *ngIf="selectedBrand">Brand:</strong>
          <span *ngIf="selectedBrand; else noBrand">
            {{ selectedBrand.brandName }}
            <span class="tone-badge">{{ selectedBrand.tone }}</span>
          </span>
          <ng-template #noBrand>
            <span class="warning-text">
              ‚ö†Ô∏è Seleziona un brand per un'analisi personalizzata
            </span>
          </ng-template>
        </div>
        <div class="platform-info" *ngIf="selectedBrand">
          <small>Piattaforma: {{ selectedPlatform }}</small>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="error-message">
      {{ error }}
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button 
        class="btn analyze-btn"
        (click)="analyzeContent()"
        [disabled]="!content || isAnalyzing || !selectedBrand"
        [title]="!selectedBrand ? 'Seleziona prima un brand' : (!content ? 'Inserisci del contenuto' : 'Analizza contenuto')">
        <span *ngIf="!isAnalyzing">üîç Analizza</span>
        <span *ngIf="isAnalyzing" class="analyzing-state">
          <div class="spinner"></div>
          Analisi in corso...
        </span>
      </button>

      <button 
        class="btn secondary-btn"
        (click)="newAnalysis()"
        [disabled]="isAnalyzing"
        title="Inizia una nuova analisi">
        Nuova
      </button>

      <button 
        class="btn preview-btn"
        (click)="toggleFinalPreview()"
        [disabled]="!analysisResult || isAnalyzing">
        üìÑ Anteprima Finale Ottimizzata
        <span *ngIf="appliedSuggestions.length > 0" class="suggestion-count">
          {{ appliedSuggestions.length }}
        </span>
      </button>
    </div>
  </div>

  <!-- Risultati Analisi -->
  <div *ngIf="analysisResult && !isAnalyzing" class="results-section">
    
    <!-- Quality Score -->
    <div class="quality-score-card">
      <div class="score-main">
        <div 
          class="score-circle" 
          [style.background]="getScoreColor(analysisResult.qualityScore)">
          {{ analysisResult.qualityScore }}/10
        </div>
        <div class="score-info">
          <h4>Qualit√† Contenuto</h4>
          <span class="score-text">{{ getScoreText(analysisResult.qualityScore) }}</span>
          <small>Confidenza: {{ (analysisResult.confidence * 100).toFixed(0) }}%</small>
        </div>
      </div>
    </div>

    <!-- Punti di Forza -->
    <div class="result-card strengths">
      <h4>‚úÖ Punti di Forza</h4>
      <ul>
        <li *ngFor="let strength of analysisResult.strengths; trackBy: trackByIndex">
          {{ strength }}
        </li>
        <li *ngIf="analysisResult.strengths.length === 0" class="no-items">
          Nessun punto di forza identificato
        </li>
      </ul>
    </div>

    <!-- Aree di Miglioramento -->
    <div class="result-card improvements">
      <h4>üéØ Aree di Miglioramento</h4>
      <ul>
        <li *ngFor="let improvement of analysisResult.improvements; trackBy: trackByIndex">
          {{ improvement }}
        </li>
        <li *ngIf="analysisResult.improvements.length === 0" class="no-items">
          Nessun miglioramento necessario
        </li>
      </ul>
    </div>

    <!-- Suggerimenti Specifici -->
    <div *ngIf="analysisResult.suggestions.length > 0" class="result-card suggestions">
      <h4>üí° Suggerimenti di Ottimizzazione</h4>
      <p class="section-description">Analisi basata su: <strong>{{ getAnalysisTypeLabel(selectedAnalysisType) }}</strong></p>
      
      <div class="suggestions-list">
        <div *ngFor="let suggestion of analysisResult.suggestions; trackBy: trackBySuggestion" 
             class="suggestion-item">
          
          <div class="suggestion-header">
            <div class="suggestion-type-info">
              <span class="suggestion-type">{{ getSuggestionTypeLabel(suggestion.type) }}</span>
              <span class="suggestion-impact" [class]="getImpactClass(suggestion.type)">
                {{ getImpactText(suggestion.type) }}
              </span>
            </div>
            <button 
              class="btn apply-btn"
              (click)="applySuggestion(suggestion)">
              Applica Miglioramento
            </button>
          </div>

          <!-- VERSIONE MIGLIORATA: HIGHLIGHT DELLE DIFFERENZE -->
          <div *ngIf="suggestion.current && suggestion.current.trim()" 
               class="suggestion-comparison-enhanced">
            
            <div class="comparison-row">
              <div class="version-label">
                <span class="version-badge current-badge">
                  <span class="badge-dot"></span>
                  Versione attuale
                </span>
                <span class="char-count">{{ suggestion.current.length }} caratteri</span>
              </div>
              
              <div class="version-label">
                <span class="version-badge suggested-badge">
                  <span class="badge-dot"></span>
                  Versione migliorata
                </span>
                <span class="char-count">{{ suggestion.suggested.length }} caratteri</span>
              </div>
            </div>

            <div class="text-comparison-container">
              <!-- Testo attuale -->
              <div class="text-version current-version">
                <div class="text-content highlight-removals">
                  {{ suggestion.current }}
                </div>
                <div class="text-legend">
                  <span class="legend-item removal">
                    <span class="legend-color removal-color"></span>
                    Testo da migliorare
                  </span>
                </div>
              </div>

              <!-- Testo migliorato -->
              <div class="text-version suggested-version">
                <div class="text-content highlight-additions">
                  {{ suggestion.suggested }}
                </div>
                <div class="text-legend">
                  <span class="legend-item addition">
                    <span class="legend-color addition-color"></span>
                    Versione ottimizzata
                  </span>
                </div>
              </div>
            </div>

            <!-- Riepilogo modifiche -->
            <div class="changes-summary">
              <h5>üìä Riepilogo modifiche:</h5>
              <div class="summary-grid">
                <div class="summary-item">
                  <span class="summary-label">Parole modificate:</span>
                  <span class="summary-value">{{ countWordChanges(suggestion.current, suggestion.suggested) }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Caratteri:</span>
                  <span class="summary-value">{{ suggestion.suggested.length - suggestion.current.length >= 0 ? '+' : '' }}{{ suggestion.suggested.length - suggestion.current.length }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Tono:</span>
                  <span class="summary-value">{{ detectToneChange(suggestion) }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- SE √à UN NUOVO ELEMENTO DA AGGIUNGERE -->
          <div *ngIf="!suggestion.current || !suggestion.current.trim()" class="suggestion-addition">
            <label>Aggiunta consigliata:</label>
            <div class="text-box addition">
              <div class="text-content">{{ suggestion.suggested }}</div>
              <div class="addition-info">
                <span class="addition-icon">‚ûï</span>
                <span class="addition-text">Nuovo elemento da inserire</span>
              </div>
            </div>
          </div>

          <!-- Motivo e Benefici -->
          <div class="suggestion-reason">
            <div class="reason-header">
              <strong>Perch√© questo miglioramento?</strong>
              <span class="reason-category">{{ getReasonCategory(suggestion.reason) }}</span>
            </div>
            <p>{{ suggestion.reason }}</p>
            <div class="reason-benefits">
              <span class="benefit-tag" *ngFor="let benefit of getSuggestionBenefits(suggestion.type)">
                {{ benefit }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Consigli Piattaforma -->
    <div *ngIf="analysisResult.platformTips.length > 0" class="result-card platform-tips">
      <h4>üì± Consigli per {{ selectedPlatform }}</h4>
      <ul>
        <li *ngFor="let tip of analysisResult.platformTips; trackBy: trackByIndex">
          {{ tip }}
        </li>
      </ul>
    </div>
  </div>

  <!-- üî• MODALE VISIBILE ANTEPRIMA POST OTTIMIZZATO FINALE -->
  <div *ngIf="showFinalPreview && optimizedContent" 
       class="final-preview-overlay" 
       (click)="toggleFinalPreview()">
    
    <div class="final-preview-modal" (click)="$event.stopPropagation()">
      
      <!-- HEADER MODALE -->
      <div class="preview-modal-header">
        <div class="header-left">
          <h3>üìÑ Post Ottimizzato Finale</h3>
          <p class="subtitle">{{ selectedBrand?.brandName }} ‚Ä¢ {{ getPlatformDisplayInfo() }}</p>
        </div>
        <div class="header-actions">
          <button class="btn icon-btn" (click)="copyToClipboard(optimizedContent)" title="Copia testo">
            üìã
          </button>
          <button class="btn icon-btn close-modal-btn" (click)="toggleFinalPreview()" title="Chiudi">
            ‚úï
          </button>
        </div>
      </div>

      <!-- STATS BAR IN ALTO -->
      <div class="preview-stats-bar">
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value">{{ appliedSuggestions.length }}</div>
            <div class="stat-label">Suggerimenti applicati</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">{{ analysisResult?.qualityScore }} ‚Üí {{ estimatedOptimizedScore }}</div>
            <div class="stat-label">Punteggio qualit√†</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">{{ optimizedContent.length }}</div>
            <div class="stat-label">Caratteri</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">{{ extractHashtags(optimizedContent).length }}</div>
            <div class="stat-label">Hashtags</div>
          </div>
        </div>
      </div>

      <!-- MAIN CONTENT - TESTO OTTIMIZZATO -->
      <div class="optimized-content-section">
        <div class="section-header">
          <h4>üìù Testo Ottimizzato</h4>
          <button class="btn copy-full-btn" (click)="copyToClipboard(optimizedContent)">
            üìã Copia tutto
          </button>
        </div>
        
        <div class="optimized-text-container">
          <div class="optimized-text" #finalContent>
            {{ optimizedContent }}
          </div>
          <div class="text-actions">
            <button class="btn text-action-btn" (click)="copyToClipboard(optimizedContent)">
              üìã Copia
            </button>
            <!-- <button class="btn text-action-btn" (click)="shareContent()">
              ‚ÜóÔ∏è Condividi
            </button>
            <button class="btn text-action-btn" (click)="downloadAsText()">
              ‚¨áÔ∏è Scarica
            </button> -->
          </div>
        </div>
      </div>

      <!-- HASHTAGS SECTION -->
      <div *ngIf="extractHashtags(optimizedContent).length > 0" class="hashtags-section">
        <div class="section-header">
          <h4>üè∑Ô∏è Hashtags</h4>
          <button class="btn copy-hashtags-btn" 
                  (click)="copyToClipboard(extractHashtags(optimizedContent).join(' '))">
            üìã Copia hashtags
          </button>
        </div>
        <div class="hashtags-grid">
          <span *ngFor="let tag of extractHashtags(optimizedContent)" 
                class="hashtag-tag" (click)="copyToClipboard(tag)">
            {{ tag }}
          </span>
        </div>
      </div>

      <!-- MODIFICHE APPLICATE -->
      <div class="applied-changes-section">
        <h4>üìù Modifiche applicate ({{ appliedSuggestions.length }})</h4>
        <div class="changes-timeline">
          <div *ngFor="let change of appliedSuggestions; trackBy: trackByIndex" 
               class="timeline-item">
            <div class="timeline-icon">
              <span [innerHTML]="getChangeIcon(change.type)"></span>
            </div>
            <div class="timeline-content">
              <div class="change-title">{{ getChangeDescription(change) }}</div>
              <div class="change-impact" [class]="getImpactClass(change.type)">
                {{ getImpactText(change.type) }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ACTIONS FOOTER -->
      <div class="preview-modal-footer">
        <div class="footer-actions">
          <button class="btn primary-action-btn" (click)="applyAllOptimizations()">
            ‚úÖ Applica modifiche
          </button>
          <button class="btn secondary-action-btn" (click)="revertAllChanges()">
            ‚Ü©Ô∏è Ripristina originale
          </button>
          <!-- <button class="btn export-action-btn" (click)="exportToPlatform()">
            üöÄ Pubblica su {{ selectedPlatform }}
          </button> -->
        </div>
        <div class="footer-info">
          <small>Il testo √® pronto per essere copiato e utilizzato sui tuoi social media</small>
        </div>
      </div>
    </div>
  </div>
</div>